{% extends 'modelo.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block estilo %}
<link rel="stylesheet" href="{% static 'css/abrir_caixa.css' %}">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
{% endblock %}

{% block corpo %}
<div id="layoutSidenav_content" class="corpo">
    <main>
        <div class="container">

            <!-- Lista de itens da venda -->
            <div class="container1">
                <div class="products-list">
                    <h2>Adicionar Produtos à Venda</h2>
                    <h3>Produtos na Venda</h3>
                    <ul id="listaItensVenda">
                        {% for item in venda.itens.all %}
                        <li style="display: flex; justify-content: space-between; align-items: center;">
                            <span>{{ item.produto.nome }} - Quantidade: {{ item.quantidade }} - {{ item.produto.preco_venda }}R$</span>
                            <form method="post" action="{% url 'remover_produto' venda.id item.id %}" style="margin:0;">
                                {% csrf_token %}
                                <button type="submit" class="myapp-btn myapp-btn-remove" style="padding: 2px 6px; font-size: 0.8rem;">❌ Remover</button>
                            </form>
                        </li>
                        {% empty %}
                        <li>Nenhum produto adicionado.</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>

            <!-- Formulário para adicionar produtos -->
            <div class="product-actions">
                <button type="button" class="myapp-btn myapp-btn-new mb-2" data-bs-toggle="modal"
                    data-bs-target="#modalCadastrarProduto">
                    Cadastrar Produto
                </button>

                <form method="post" id="formAdicionarProduto">
                    {% csrf_token %}
                    <input type="text" class="input-custom" id="buscaProduto" placeholder="Buscar produto por nome...">
                    <input type="text" class="input-custom" id="buscaCodigoBarras" placeholder="Buscar por código de barras..." autofocus>
                    <select id="listaProdutos" name="produto_id" class="input-custom">
                        {% for produto in produtos %}
                        <option value="{{ produto.id }}" data-codigo-barras="{{ produto.codigo_barras }}">{{ produto.nome }}</option>
                        {% endfor %}
                    </select>
                    <input type="number" name="quantidade" min="1" value="1" class="input-custom">
                    <input type="submit" value="Adicionar Produto" class="myapp-btn myapp-btn-add">
                </form>

                <!-- Formulário para aplicar desconto -->
                <form method="post" action="{% url 'adicionar_produto' venda.id %}" class="discount-form mt-2">
                    {% csrf_token %}
                    <input type="number" name="desconto" min="0" max="100" step="0.01" placeholder="Desconto (%)" class="input-custom">
                    <input type="submit" value="Aplicar Desconto" class="myapp-btn myapp-btn-discount">
                </form>

                <!-- Totais -->
                <h5>Total: <span class="total-highlight">{{ venda.total }}R$</span></h5>
                <h5>Total com Desconto de {{ venda.desconto }}%: <span class="total-highlight">{{ venda.total_com_desconto }}R$</span></h5>
            </div>

        </div>

        <!-- Ações de venda -->
        <div class="sale-actions mt-3">
            <a href="{% url 'iniciar_venda' %}" class="myapp-btn myapp-btn-new">Abrir Nova Venda</a>
            <a href="{% url 'finalizar_venda' venda.id %}" class="myapp-btn myapp-btn-finish">Finalizar Venda</a>
        </div>

    </main>
</div>

<!-- Modal para cadastrar produto -->
<div class="modal fade" id="modalCadastrarProduto" tabindex="-1" aria-labelledby="modalCadastrarProdutoLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalCadastrarProdutoLabel">Cadastrar Novo Produto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <form id="formModalProduto" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    {{ form|crispy }}
                </div>
                <div class="modal-footer">
                    <button type="button" class="myapp-btn myapp-btn-remove" data-bs-dismiss="modal">Fechar</button>
                    <button type="submit" class="myapp-btn myapp-btn-add">Cadastrar Produto</button>
                </div>
            </form>
            <div id="mensagemProduto" class="mt-2"></div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<!-- jQuery completo -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="{% static 'js/jscaixa.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
$(document).ready(function() {
    // Focar automaticamente no campo de busca por código de barras
    $("#buscaCodigoBarras").focus();

    // Enviar formulário do modal via AJAX
    $("#formModalProduto").submit(function(e) {
        e.preventDefault();
        var formData = new FormData(this);

        $.ajax({
            url: "{% url 'cadastrar_produto_ajax' %}", // view AJAX precisa ser criada
            type: "POST",
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                if(response.status === "cadastrado" || response.status === "atualizado") {
                    // Mensagem de sucesso
                    $("#mensagemProduto").html("<p style='color:green;'>" + response.mensagem + "</p>");

                    // Fecha o modal imediatamente
                    $("#modalCadastrarProduto").modal('hide');

                    // Recarrega a página após 0.5s
                    setTimeout(function() {
                        location.reload();
                    }, 500);

                } else if(response.status === "erro") {
                    $("#mensagemProduto").html("<p style='color:red;'>Erro: " + JSON.stringify(response.erros) + "</p>");
                }
            },
            error: function() {
                $("#mensagemProduto").html("<p style='color:red;'>Ocorreu um erro ao cadastrar o produto.</p>");
            }
        });
    });
});
</script>

{% endblock %}
